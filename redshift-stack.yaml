AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure Nested Stack for Redshift Cluster'

Parameters:
  RedshiftMasterUsername:
    Type: String
    Default: admin
    NoEcho: true
    Description: Username for Redshift cluster master user
    
  RedshiftMasterPassword:
    Type: String
    NoEcho: true
    Description: Password for Redshift cluster master user
    MinLength: 8
    
  VPCId:
    Type: String
    Description: VPC ID for Redshift cluster
    
  PrivateSubnet1Id:
    Type: String
    Description: Private subnet 1 ID
    
  PrivateSubnet2Id:
    Type: String
    Description: Private subnet 2 ID
    
  KMSKeyArn:
    Type: String
    Description: KMS Key ARN for encryption
    
  AccessLogsBucketName:
    Type: String
    Description: S3 bucket for access logs

Resources:
  # Redshift Subnet Group
  RedshiftSubnetGroup:
    Type: AWS::Redshift::ClusterSubnetGroup
    Properties:
      Description: Subnet group for Redshift cluster in private subnets
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      Tags:
        - Key: Name
          Value: AB3-Redshift-SubnetGroup

  # VPC Endpoints for AWS Services
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable

  RedshiftVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.redshift'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  LogsVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.logs'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  # Security Group for VPC Endpoints
  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC endpoints with explicit egress rules
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16
          Description: HTTPS access from VPC resources
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16
          Description: HTTPS outbound within VPC for AWS service endpoints
      Tags:
        - Key: Name
          Value: AB3-VPCEndpoint-SG

  # Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: AB3-Private-RouteTable

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1Id
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2Id
      RouteTableId: !Ref PrivateRouteTable

  # Secure Security Groups (no internet access)
  RedshiftSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Redshift cluster with VPC endpoint access only
      VpcId: !Ref VPCId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref VPCEndpointSecurityGroup
          Description: HTTPS access to VPC endpoints for AWS services
      Tags:
        - Key: Name
          Value: AB3-Redshift-SG

  GlueSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Glue jobs with VPC endpoint access only
      VpcId: !Ref VPCId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5439
          ToPort: 5439
          CidrIp: 10.0.0.0/16
          Description: Redshift access within VPC
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref VPCEndpointSecurityGroup
          Description: HTTPS access to VPC endpoints for AWS services
      Tags:
        - Key: Name
          Value: AB3-Glue-SG

  # Additional ingress rules to break circular dependencies
  RedshiftIngressFromGlue:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RedshiftSecurityGroup
      IpProtocol: tcp
      FromPort: 5439
      ToPort: 5439
      SourceSecurityGroupId: !Ref GlueSecurityGroup
      Description: Allow Redshift access from Glue ETL jobs only

  VPCEndpointIngressFromRedshift:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref VPCEndpointSecurityGroup
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443
      SourceSecurityGroupId: !Ref RedshiftSecurityGroup
      Description: HTTPS access from Redshift

  VPCEndpointIngressFromGlue:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref VPCEndpointSecurityGroup
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443
      SourceSecurityGroupId: !Ref GlueSecurityGroup
      Description: HTTPS access from Glue jobs

  # Redshift Parameter Group for Security
  RedshiftParameterGroup:
    Type: AWS::Redshift::ClusterParameterGroup
    Properties:
      Description: Secure parameter group for AB3 Redshift cluster
      ParameterGroupFamily: redshift-1.0
      Parameters:
        - ParameterName: enable_user_activity_logging
          ParameterValue: 'true'
        - ParameterName: require_ssl
          ParameterValue: 'true'
        - ParameterName: enable_case_sensitive_identifier
          ParameterValue: 'true'
      Tags:
        - Key: Name
          Value: AB3-Redshift-ParamGroup

  # Secure Redshift Cluster
  RedshiftCluster:
    Type: AWS::Redshift::Cluster
    Properties:
      ClusterIdentifier: tco-tbm-ab3
      DBName: tco_tbm_db
      MasterUsername: !Ref RedshiftMasterUsername
      MasterUserPassword: !Ref RedshiftMasterPassword
      NodeType: ra3.xlplus
      ClusterType: single-node
      ClusterSubnetGroupName: !Ref RedshiftSubnetGroup
      VpcSecurityGroupIds:
        - !Ref RedshiftSecurityGroup
      PubliclyAccessible: false
      Port: 5439
      Encrypted: true
      KmsKeyId: !Ref KMSKeyArn
      EnhancedVpcRouting: true
      ClusterParameterGroupName: !Ref RedshiftParameterGroup
      AutomatedSnapshotRetentionPeriod: 7
      PreferredMaintenanceWindow: sun:03:00-sun:04:00
      Tags:
        - Key: Name
          Value: tco-tbm-ab3
        - Key: Environment
          Value: Production
        - Key: Application
          Value: AB3-HotelBooking

  # CloudWatch Log Group for Redshift
  RedshiftLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/redshift/cluster/tco-tbm-ab3
      RetentionInDays: 90

  # CloudWatch Alarms for Redshift
  RedshiftCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Redshift cluster high CPU utilization
      MetricName: CPUUtilization
      Namespace: AWS/Redshift
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ClusterIdentifier
          Value: !Ref RedshiftCluster
      TreatMissingData: notBreaching

  RedshiftConnectionsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Redshift cluster high connection count
      MetricName: DatabaseConnections
      Namespace: AWS/Redshift
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ClusterIdentifier
          Value: !Ref RedshiftCluster
      TreatMissingData: notBreaching

Outputs:
  RedshiftClusterEndpoint:
    Description: "Redshift Cluster Endpoint"
    Value: !GetAtt RedshiftCluster.Endpoint.Address
    
  RedshiftClusterPort:
    Description: "Redshift Cluster Port"
    Value: !GetAtt RedshiftCluster.Endpoint.Port
    
  RedshiftClusterId:
    Description: "Redshift Cluster Identifier"
    Value: !Ref RedshiftCluster
    
  RedshiftSecurityGroupId:
    Description: "Redshift Security Group ID"
    Value: !Ref RedshiftSecurityGroup
    
  GlueSecurityGroupId:
    Description: "Glue Security Group ID"
    Value: !Ref GlueSecurityGroup