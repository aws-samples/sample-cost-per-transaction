AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for AB3 Full Stack Application'

Parameters:
  RedshiftMasterUsername:
    Type: String
    Default: admin
    NoEcho: true
    Description: Username for Redshift cluster master user
    
  RedshiftMasterPassword:
    Type: String
    NoEcho: true
    Description: Password for Redshift cluster master user
    MinLength: 8

Resources:
  # Lambda Functions
  XRayExtractionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: ab3-xray-XRayExtractionFunction
      Handler: lambda_function.lambda_handler
      Runtime: python3.9
      Code:
        S3Bucket: !Ref DeploymentBucket
        S3Key: lambda/xray-extraction.zip
      MemorySize: 512
      Timeout: 300
      Role: !GetAtt XRayExtractionRole.Arn
      ReservedConcurrentExecutions: 10
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      DeadLetterConfig:
        TargetArn: !GetAtt DeadLetterQueue.Arn
      Environment:
        Variables:
          S3_BUCKET: !Ref XRayDataBucket
      KmsKeyArn: !GetAtt GlueKMSKey.Arn

  HotelTraceGeneratorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: lambda-generator-HotelTraceGeneratorFunction
      Handler: lambda_function.lambda_handler
      Runtime: python3.9
      Code:
        S3Bucket: !Ref DeploymentBucket
        S3Key: lambda/hotel-trace-generator.zip
      MemorySize: 256
      Timeout: 30
      Role: !GetAtt HotelTraceGeneratorRole.Arn
      ReservedConcurrentExecutions: 5
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      DeadLetterConfig:
        TargetArn: !GetAtt DeadLetterQueue.Arn
      TracingConfig:
        Mode: Active
      KmsKeyArn: !GetAtt GlueKMSKey.Arn

  # Cognito User Pool for API Authentication
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: AB3HotelBookingUserPool
      Policies:
        PasswordPolicy:
          MinimumLength: 12
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
      AutoVerifiedAttributes:
        - email
      UserPoolTags:
        Environment: Production
        Application: AB3HotelBooking

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: AB3HotelBookingClient
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30

  # API Gateway with WAF and Authentication
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: AB3HotelBookingWAF
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      Rules:
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSetMetric
        - Name: AWSManagedRulesOWASPTop10
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesOWASPTop10RuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: OWASPTop10Metric
        - Name: RateLimitRule
          Priority: 3
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitMetric
        - Name: Log4jProtection
          Priority: 4
          Action:
            Block: {}
          Statement:
            OrStatement:
              Statements:
                - ByteMatchStatement:
                    SearchString: "${jndi:"
                    FieldToMatch:
                      AllQueryArguments: {}
                    TextTransformations:
                      - Priority: 0
                        Type: URL_DECODE
                      - Priority: 1
                        Type: LOWERCASE
                - ByteMatchStatement:
                    SearchString: "${jndi:"
                    FieldToMatch:
                      Body: {}
                    TextTransformations:
                      - Priority: 0
                        Type: URL_DECODE
                      - Priority: 1
                        Type: LOWERCASE
                - ByteMatchStatement:
                    SearchString: "${jndi:"
                    FieldToMatch:
                      SingleHeader:
                        Name: user-agent
                    TextTransformations:
                      - Priority: 0
                        Type: URL_DECODE
                      - Priority: 1
                        Type: LOWERCASE
                - ByteMatchStatement:
                    SearchString: "jndi:"
                    FieldToMatch:
                      AllQueryArguments: {}
                    TextTransformations:
                      - Priority: 0
                        Type: URL_DECODE
                      - Priority: 1
                        Type: LOWERCASE
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: Log4jProtectionMetric

  HotelTracingAPI:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: HotelTracingAPI
      Description: Secure API to invoke hotel tracing Lambda function
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: execute-api:Invoke
            Resource: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HotelTracingAPI}/*'
            Condition:
              IpAddress:
                aws:SourceIp:
                  - 0.0.0.0/0

  ApiGatewayAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: CognitoAuthorizer
      Type: COGNITO_USER_POOLS
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref HotelTracingAPI
      ProviderARNs:
        - !GetAtt UserPool.Arn

  HotelTracesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref HotelTracingAPI
      ParentId: !GetAtt HotelTracingAPI.RootResourceId
      PathPart: 'hotel-traces'

  HotelTracesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref HotelTracingAPI
      ResourceId: !Ref HotelTracesResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref ApiGatewayAuthorizer
      RequestValidatorId: !Ref RequestValidator
      RequestModels:
        application/json: !Ref HotelTracesRequestModel
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HotelTraceGeneratorFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # CORS Options Method
  HotelTracesOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref HotelTracingAPI
      ResourceId: !Ref HotelTracesResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  RequestValidator:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      RestApiId: !Ref HotelTracingAPI
      ValidateRequestBody: true
      ValidateRequestParameters: true

  HotelTracesRequestModel:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId: !Ref HotelTracingAPI
      ContentType: application/json
      Schema:
        $schema: http://json-schema.org/draft-04/schema#
        type: object
        properties:
          mode:
            type: string
            enum: ["search", "booking", "both"]
        required:
          - mode

  WebACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn: !Sub arn:aws:apigateway:${AWS::Region}::/restapis/${HotelTracingAPI}/stages/prod
      WebACLArn: !GetAtt WebACL.Arn
    DependsOn: ApiDeployment

  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - HotelTracesMethod
      - HotelTracesOptionsMethod
    Properties:
      RestApiId: !Ref HotelTracingAPI
      StageName: prod

  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref HotelTracingAPI
      DeploymentId: !Ref ApiDeployment
      StageName: prod
      TracingEnabled: true
      CachingEnabled: true
      CacheClusterEnabled: true
      CacheClusterSize: '0.5'
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","caller":"$context.identity.caller","user":"$context.identity.user","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}'
      ThrottleSettings:
        RateLimit: 1000
        BurstLimit: 2000
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: false
          MetricsEnabled: true
          ThrottlingRateLimit: 100
          ThrottlingBurstLimit: 200
          CachingEnabled: true
          CacheTtlInSeconds: 300

  # Usage Plan for API Gateway
  ApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: AB3-API-Usage-Plan
      Description: Usage plan for AB3 Hotel Booking API
      ApiStages:
        - ApiId: !Ref HotelTracingAPI
          Stage: !Ref ApiGatewayStage
      Throttle:
        RateLimit: 1000
        BurstLimit: 2000
      Quota:
        Limit: 10000
        Period: DAY

  ApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Name: AB3-API-Key
      Description: API Key for AB3 Hotel Booking API
      Enabled: true

  ApiUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref ApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref ApiUsagePlan

  # Glue Resources
  GlueServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: GlueS3AccessMinimal
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${XRayDataBucket.Arn}/xray-data/*'
                  - !GetAtt XRayDataBucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${GlueDataBucket.Arn}/processed-data/*'
                  - !Sub '${GlueDataBucket.Arn}/temp/*'
                  - !Sub '${GlueDataBucket.Arn}/scripts/*'
                  - !GetAtt GlueDataBucket.Arn
        - PolicyName: GlueKMSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt GlueKMSKey.Arn

  # KMS Key for Glue Encryption with Key Rotation
  GlueKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS Key for Glue ETL encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:TagResource
              - kms:UntagResource
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
            Condition:
              StringEquals:
                'kms:ViaService': 
                  - !Sub 's3.${AWS::Region}.amazonaws.com'
                  - !Sub 'logs.${AWS::Region}.amazonaws.com'
                  - !Sub 'glue.${AWS::Region}.amazonaws.com'
          - Sid: Allow Glue Service
            Effect: Allow
            Principal:
              AWS: !GetAtt GlueServiceRole.Arn
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
              - kms:DescribeKey
            Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
            Condition:
              StringEquals:
                'kms:ViaService': 
                  - !Sub 's3.${AWS::Region}.amazonaws.com'
                  - !Sub 'logs.${AWS::Region}.amazonaws.com'
                  - !Sub 'glue.${AWS::Region}.amazonaws.com'

  GlueKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/ab3-glue-encryption
      TargetKeyId: !Ref GlueKMSKey

  GlueDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ab3-glue-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref GlueKMSKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLogsBucket
        LogFilePrefix: glue-data-access/
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: s3:ObjectCreated:*
            CloudWatchConfiguration:
              LogGroupName: !Ref S3AccessLogGroup

  GlueDataBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref GlueDataBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${GlueDataBucket.Arn}/*'
              - !GetAtt GlueDataBucket.Arn
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: AllowGlueAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt GlueServiceRole.Arn
            Action:
              - 's3:GetObject'
              - 's3:PutObject'
              - 's3:DeleteObject'
              - 's3:ListBucket'
            Resource:
              - !Sub '${GlueDataBucket.Arn}/*'
              - !GetAtt GlueDataBucket.Arn

  # Glue Security Configuration
  GlueSecurityConfiguration:
    Type: AWS::Glue::SecurityConfiguration
    Properties:
      Name: AB3-Glue-Security-Config
      EncryptionConfiguration:
        S3Encryptions:
          - S3EncryptionMode: SSE-KMS
            KmsKeyArn: !GetAtt GlueKMSKey.Arn
        CloudWatchEncryption:
          CloudWatchEncryptionMode: SSE-KMS
          KmsKeyArn: !GetAtt GlueKMSKey.Arn
        JobBookmarksEncryption:
          JobBookmarksEncryptionMode: CSE-KMS
          KmsKeyArn: !GetAtt GlueKMSKey.Arn

  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: ab3_trace_database
        Description: Database for AB3 trace data

  PrepTraceDataJob:
    Type: AWS::Glue::Job
    Properties:
      Name: Prep-Trace-Data-for-TCO_TBM
      Role: !GetAtt GlueServiceRole.Arn
      SecurityConfiguration: !Ref GlueSecurityConfiguration
      ExecutionProperty:
        MaxConcurrentRuns: 1
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${GlueDataBucket}/scripts/prep_trace_data.py'
      DefaultArguments:
        '--job-language': 'python'
        '--TempDir': !Sub 's3://${GlueDataBucket}/temp/'
        '--enable-metrics': ''
      MaxRetries: 0
      GlueVersion: '3.0'
      NumberOfWorkers: 2
      WorkerType: 'G.1X'
      Timeout: 60

  ETLFinalWithAthenaJob:
    Type: AWS::Glue::Job
    Properties:
      Name: ETL-Final-With-Athena-Only
      Role: !GetAtt GlueServiceRole.Arn
      SecurityConfiguration: !Ref GlueSecurityConfiguration
      ExecutionProperty:
        MaxConcurrentRuns: 1
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${GlueDataBucket}/scripts/etl_final_with_athena.py'
      DefaultArguments:
        '--job-language': 'python'
        '--TempDir': !Sub 's3://${GlueDataBucket}/temp/'
        '--enable-metrics': ''
      MaxRetries: 0
      GlueVersion: '3.0'
      NumberOfWorkers: 2
      WorkerType: 'G.1X'
      Timeout: 60

  CRSRMSHotelsJob:
    Type: AWS::Glue::Job
    Properties:
      Name: CRS-RMS-and-Hotels
      Role: !GetAtt GlueServiceRole.Arn
      SecurityConfiguration: !Ref GlueSecurityConfiguration
      ExecutionProperty:
        MaxConcurrentRuns: 1
      Command:
        Name: glueetl
        ScriptLocation: !Sub 's3://${GlueDataBucket}/scripts/crs_rms_hotels.py'
      DefaultArguments:
        '--job-language': 'python'
        '--TempDir': !Sub 's3://${GlueDataBucket}/temp/'
        '--enable-metrics': ''
      MaxRetries: 0
      GlueVersion: '3.0'
      NumberOfWorkers: 2
      WorkerType: 'G.1X'
      Timeout: 60

  # Redshift Cluster
  RedshiftCluster:
    Type: AWS::Redshift::Cluster
    Properties:
      ClusterIdentifier: tco-tbm-ab3
      DBName: tco_tbm_db
      MasterUsername: !Ref RedshiftMasterUsername
      MasterUserPassword: !Ref RedshiftMasterPassword
      NodeType: dc2.large
      ClusterType: single-node
      DBSubnetGroupName: !Ref RedshiftSubnetGroup
      VpcSecurityGroupIds:
        - !Ref RedshiftSecurityGroup
      PubliclyAccessible: false
      Port: 5439
      Encrypted: true
      KmsKeyId: !Ref GlueKMSKey
      EnhancedVpcRouting: true
      LoggingProperties:
        BucketName: !Ref AccessLogsBucket
        S3KeyPrefix: redshift-logs/
      ClusterParameterGroupName: !Ref RedshiftParameterGroup

  RedshiftParameterGroup:
    Type: AWS::Redshift::ClusterParameterGroup
    Properties:
      Description: Parameter group for AB3 Redshift cluster
      ParameterGroupFamily: redshift-1.0
      Parameters:
        - ParameterName: enable_user_activity_logging
          ParameterValue: 'true'
        - ParameterName: log_statement
          ParameterValue: 'all'
        - ParameterName: require_ssl
          ParameterValue: 'true'
      Tags:
        - Key: Name
          Value: tco-tbm-ab3
        - Key: Environment
          Value: Production

  # VPC for Redshift
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: AB3-VPC

  VPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogRole.Arn

  VPCFlowLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/vpc/flowlogs
      RetentionInDays: 30
      KmsKeyId: !GetAtt GlueKMSKey.Arn

  VPCFlowLogRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: VPCFlowLogDeliveryRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/vpc/flowlogs*'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: AB3-Private-Subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: AB3-Private-Subnet-2

  RedshiftSubnetGroup:
    Type: AWS::Redshift::SubnetGroup
    Properties:
      Description: Subnet group for Redshift cluster
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  RedshiftSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Redshift cluster with restricted access
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5439
          ToPort: 5439
          SourceSecurityGroupId: !Ref GlueSecurityGroup
          Description: Allow Redshift access from Glue ETL jobs only
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound for AWS API calls and services only
      Tags:
        - Key: Name
          Value: AB3-Redshift-SG

  GlueSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Glue jobs
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5439
          ToPort: 5439
          DestinationSecurityGroupId: !Ref RedshiftSecurityGroup
          Description: Access to Redshift
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound for AWS services
      Tags:
        - Key: Name
          Value: AB3-Glue-SG

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound for AWS services
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          DestinationSecurityGroupId: !Ref GlueSecurityGroup
          Description: Access to Glue services
      Tags:
        - Key: Name
          Value: AB3-Lambda-SG

  # Dead Letter Queue for Lambda functions
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: AB3-Lambda-DLQ
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: !Ref GlueKMSKey

  # S3 Buckets
  # Access Logs Bucket
  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ab3-access-logs-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteAccessLogs
            Status: Enabled
            ExpirationInDays: 90
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30

  DeploymentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ab3-deployment-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLogsBucket
        LogFilePrefix: deployment-access/

  DeploymentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DeploymentBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${DeploymentBucket.Arn}/*'
              - !GetAtt DeploymentBucket.Arn
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: AllowLambdaAccess
            Effect: Allow
            Principal:
              AWS:
                - !GetAtt XRayExtractionRole.Arn
                - !GetAtt HotelTraceGeneratorRole.Arn
            Action:
              - 's3:GetObject'
            Resource: !Sub '${DeploymentBucket.Arn}/lambda/*'

  XRayDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ab3-xray-data-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 90
                StorageClass: GLACIER
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 365
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref GlueKMSKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLogsBucket
        LogFilePrefix: xray-data-access/

  XRayDataBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref XRayDataBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${XRayDataBucket.Arn}/*'
              - !GetAtt XRayDataBucket.Arn
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: AllowXRayExtractionAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt XRayExtractionRole.Arn
            Action:
              - 's3:PutObject'
              - 's3:PutObjectAcl'
              - 's3:GetBucketLocation'
            Resource:
              - !Sub '${XRayDataBucket.Arn}/xray-data/*'
              - !GetAtt XRayDataBucket.Arn

  # IAM Roles with Least Privilege
  XRayExtractionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: XRayAccessMinimal
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - xray:GetTraceSummaries
                  - xray:BatchGetTraces
                Resource: 
                  - !Sub 'arn:aws:xray:${AWS::Region}:${AWS::AccountId}:trace/*'
        - PolicyName: S3AccessMinimal
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !Sub '${XRayDataBucket.Arn}/xray-data/*'
              - Effect: Allow
                Action:
                  - s3:GetBucketLocation
                Resource: !GetAtt XRayDataBucket.Arn
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt DeadLetterQueue.Arn

  HotelTraceGeneratorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: XRayWriteMinimal
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                Resource: 
                  - !Sub 'arn:aws:xray:${AWS::Region}:${AWS::AccountId}:trace/*'
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt DeadLetterQueue.Arn

  # Amplify App
  AmplifyApp:
    Type: AWS::Amplify::App
    Properties:
      Name: hotel-booking-app
      Description: Hotel Booking Application
      Repository: https://github.com/yourusername/hotel-booking-app
      BuildSpec: |-
        version: 1
        frontend:
          phases:
            preBuild:
              commands:
                - npm ci
            build:
              commands:
                - npm run build
          artifacts:
            baseDirectory: build
            files:
              - '**/*'
          cache:
            paths:
              - node_modules/**/*
      IAMServiceRole: !GetAtt AmplifyServiceRole.Arn
      EnableBranchAutoBuild: true
      EnvironmentVariables:
        - Name: REACT_APP_API_URL
          Value: !GetAtt HotelTracingAPI.RootResourceId

  AmplifyBranch:
    Type: AWS::Amplify::Branch
    Properties:
      AppId: !GetAtt AmplifyApp.AppId
      BranchName: main
      EnableAutoBuild: true
      Stage: PRODUCTION

  AmplifyServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: amplify.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AmplifyMinimalAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - amplify:GetApp
                  - amplify:GetBranch
                  - amplify:ListBranches
                  - amplify:GetJob
                  - amplify:ListJobs
                  - amplify:StartJob
                  - amplify:StopJob
                  - amplify:GetWebhook
                  - amplify:ListWebhooks
                  - amplify:CreateDeployment
                  - amplify:GetDeployment
                  - amplify:ListDeployments
                Resource:
                  - !Sub 'arn:aws:amplify:${AWS::Region}:${AWS::AccountId}:apps/${AmplifyApp}/*'
                  - !Sub 'arn:aws:amplify:${AWS::Region}:${AWS::AccountId}:apps/${AmplifyApp}'
              - Effect: Allow
                Action:
                  - codecommit:GetRepository
                  - codecommit:ListBranches
                  - codecommit:ListRepositories
                  - codecommit:GetBranch
                  - codecommit:GetCommit
                  - codecommit:GetDifferences
                  - codecommit:GetReferences
                  - codecommit:ListTagsForResource
                Resource:
                  - !Sub 'arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !Sub 'arn:aws:s3:::amplify-${AmplifyApp}-*'
                  - !Sub 'arn:aws:s3:::amplify-${AmplifyApp}-*/*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/amplify/*'

  # CloudWatch Monitoring and Logging with KMS Encryption
  S3AccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/s3/ab3-access-logs
      RetentionInDays: 90
      KmsKeyId: !GetAtt GlueKMSKey.Arn

  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${HotelTracingAPI}'
      RetentionInDays: 30
      KmsKeyId: !GetAtt GlueKMSKey.Arn

  SecurityAlertsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/ab3/security-alerts
      RetentionInDays: 365
      KmsKeyId: !GetAtt GlueKMSKey.Arn

  # CloudWatch Alarms
  HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: High error rate detected in API Gateway
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref HotelTracingAPI
      AlarmActions:
        - !Ref SecurityAlertsTopic

  UnauthorizedAccessAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Unauthorized access attempts detected
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref HotelTracingAPI
      AlarmActions:
        - !Ref SecurityAlertsTopic

  # SNS Topic for Security Alerts
  SecurityAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: AB3-Security-Alerts
      DisplayName: AB3 Security Alerts
      KmsMasterKeyId: alias/aws/sns

  LambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref HotelTraceGeneratorFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HotelTracingAPI}/*/POST/hotel-traces
Outputs:
  ApiEndpoint:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${HotelTracingAPI}.execute-api.${AWS::Region}.amazonaws.com/prod/"
  
  XRayExtractionFunctionArn:
    Description: "X-Ray Extraction Lambda Function ARN"
    Value: !GetAtt XRayExtractionFunction.Arn
  
  HotelTraceGeneratorFunctionArn:
    Description: "Hotel Trace Generator Lambda Function ARN"
    Value: !GetAtt HotelTraceGeneratorFunction.Arn
  
  RedshiftClusterEndpoint:
    Description: "Redshift Cluster Endpoint"
    Value: !GetAtt RedshiftCluster.Endpoint.Address
  
  RedshiftClusterPort:
    Description: "Redshift Cluster Port"
    Value: !GetAtt RedshiftCluster.Endpoint.Port
  
  AmplifyAppURL:
    Description: "Amplify App URL"
    Value: !Sub "https://${AmplifyBranch.BranchName}.${AmplifyApp.DefaultDomain}"
  
  GlueDataBucketName:
    Description: "Glue Data S3 Bucket"
    Value: !Ref GlueDataBucket
  
  XRayDataBucketName:
    Description: "X-Ray Data S3 Bucket"
    Value: !Ref XRayDataBucket